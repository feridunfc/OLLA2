version: '3.8'
services:
  olla2-app:
    build: .
    ports: ["8000:8000"]
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLA2_HOME=/app
      - DATABASE_URL=sqlite:///app/ledger.db
      - LOG_LEVEL=INFO
    volumes: ["./data:/app/data", "./logs:/app/logs"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes: ["./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml"]
    command: ['--config.file=/etc/prometheus/prometheus.yml', '--storage.tsdb.path=/prometheus', '--web.enable-lifecycle']
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    environment: [GF_SECURITY_ADMIN_PASSWORD=admin123, GF_USERS_ALLOW_SIGN_UP=false]
    volumes: ["./monitoring/grafana/dashboards:/var/lib/grafana/dashboards", "./monitoring/grafana/provisioning:/etc/grafana/provisioning"]
    depends_on: [prometheus]
    restart: unless-stopped